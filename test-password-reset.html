<!DOCTYPE html>
<html lang="fr">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test Password Reset Flow</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 50px auto;
            padding: 20px;
            background: #1a1a1a;
            color: #fff;
        }

        .test-section {
            background: #2a2a2a;
            padding: 20px;
            margin: 20px 0;
            border-radius: 8px;
            border: 1px solid #444;
        }

        .success {
            color: #10b981;
        }

        .error {
            color: #ef4444;
        }

        .warning {
            color: #f59e0b;
        }

        button {
            background: #3b82f6;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 6px;
            cursor: pointer;
            margin: 5px;
        }

        button:hover {
            background: #2563eb;
        }

        code {
            background: #1a1a1a;
            padding: 2px 6px;
            border-radius: 4px;
            font-family: monospace;
        }

        .log {
            background: #1a1a1a;
            padding: 10px;
            margin: 10px 0;
            border-radius: 4px;
            font-family: monospace;
            font-size: 12px;
        }
    </style>
</head>

<body>
    <h1>üß™ Test du Flux de R√©initialisation de Mot de Passe</h1>

    <div class="test-section">
        <h2>1Ô∏è‚É£ Test de D√©tection du Hash</h2>
        <p>Simule un clic sur le lien de r√©initialisation re√ßu par email</p>
        <button onclick="testHashDetection()">Simuler le lien de reset</button>
        <div id="hash-result" class="log"></div>
    </div>

    <div class="test-section">
        <h2>2Ô∏è‚É£ Test d'Affichage du Formulaire</h2>
        <p>V√©rifie que le formulaire <code>auth-form-reset</code> s'affiche correctement</p>
        <button onclick="testFormDisplay()">Tester l'affichage</button>
        <div id="form-result" class="log"></div>
    </div>

    <div class="test-section">
        <h2>3Ô∏è‚É£ Test de l'URL de Redirection Backend</h2>
        <p>V√©rifie la logique de construction de l'URL</p>
        <button onclick="testUrlLogic()">Tester la logique</button>
        <div id="url-result" class="log"></div>
    </div>

    <div class="test-section">
        <h2>üìã R√©sum√© du Flux Complet</h2>
        <ol>
            <li>Utilisateur demande reset ‚Üí Email envoy√© avec
                <code>${APP_URL}/index.html#access_token=xxx&type=recovery</code></li>
            <li>Clic sur lien ‚Üí <code>auth.js:checkRecoveryMode()</code> d√©tecte le hash</li>
            <li>Appel <code>showAuthModal('reset')</code> ‚Üí Affiche <code>auth-form-reset</code></li>
            <li>Utilisateur entre nouveau mot de passe ‚Üí <code>handleAuthReset()</code></li>
            <li>Extraction du token du hash ‚Üí <code>Auth.updatePassword()</code></li>
            <li>Backend met √† jour via Supabase ‚Üí Succ√®s ‚úÖ</li>
        </ol>
    </div>

    <script>
        function testHashDetection() {
            const result = document.getElementById('hash-result');
            result.innerHTML = '<strong>Test en cours...</strong><br>';

            // Simuler le hash Supabase
            const testHash = '#access_token=eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9&type=recovery&expires_in=3600';

            result.innerHTML += `Hash simul√©: <span class="warning">${testHash}</span><br>`;

            // Test de d√©tection
            const hasToken = testHash.includes('access_token=');
            const hasType = testHash.includes('type=recovery');

            result.innerHTML += `‚úì Contient access_token: <span class="${hasToken ? 'success' : 'error'}">${hasToken}</span><br>`;
            result.innerHTML += `‚úì Contient type=recovery: <span class="${hasType ? 'success' : 'error'}">${hasType}</span><br>`;

            if (hasToken && hasType) {
                result.innerHTML += `<br><span class="success">‚úÖ Le hash serait correctement d√©tect√© par auth.js:checkRecoveryMode()</span>`;
            } else {
                result.innerHTML += `<br><span class="error">‚ùå Le hash ne serait PAS d√©tect√©</span>`;
            }
        }

        function testFormDisplay() {
            const result = document.getElementById('form-result');
            result.innerHTML = '<strong>Test en cours...</strong><br>';

            // Test de la logique switchAuthTab
            const tab = 'reset';
            const expectedFormId = 'auth-form-' + tab; // = 'auth-form-reset'

            result.innerHTML += `Tab demand√©: <span class="warning">${tab}</span><br>`;
            result.innerHTML += `Formulaire recherch√©: <span class="warning">${expectedFormId}</span><br>`;
            result.innerHTML += `Formulaire dans index.html: <span class="warning">auth-form-reset</span><br>`;

            const match = expectedFormId === 'auth-form-reset';

            if (match) {
                result.innerHTML += `<br><span class="success">‚úÖ Le formulaire serait correctement affich√©</span><br>`;
                result.innerHTML += `<span class="success">‚úì Les onglets seraient cach√©s (tab === 'reset')</span>`;
            } else {
                result.innerHTML += `<br><span class="error">‚ùå Le formulaire ne serait PAS affich√©</span>`;
            }
        }

        function testUrlLogic() {
            const result = document.getElementById('url-result');
            result.innerHTML = '<strong>Test en cours...</strong><br>';

            // Simuler diff√©rents sc√©narios
            const scenarios = [
                { name: 'Production Vercel', APP_URL: 'https://soloprice-pro.vercel.app', expected: 'https://soloprice-pro.vercel.app/index.html' },
                { name: 'APP_URL avec localhost (AVANT)', APP_URL: 'http://localhost:5050', expected: 'http://localhost:5050/index.html (mais serait remplac√© par req.get("host"))' },
                { name: 'APP_URL avec localhost (APR√àS)', APP_URL: 'http://localhost:5050', expected: 'http://localhost:5050/index.html (utilis√© tel quel)' },
                { name: 'APP_URL non d√©fini', APP_URL: undefined, expected: 'Construit depuis req.get("host")' }
            ];

            scenarios.forEach((scenario, i) => {
                result.innerHTML += `<br><strong>${i + 1}. ${scenario.name}</strong><br>`;
                result.innerHTML += `APP_URL = <code>${scenario.APP_URL || 'undefined'}</code><br>`;

                // Logique APR√àS correction
                let origin = scenario.APP_URL;
                if (!origin) {
                    origin = 'Fallback vers req.get("host")';
                }

                result.innerHTML += `R√©sultat: <span class="success">${origin}/index.html</span><br>`;
            });

            result.innerHTML += `<br><span class="success">‚úÖ La logique fait maintenant confiance √† APP_URL</span>`;
        }
    </script>
</body>

</html>